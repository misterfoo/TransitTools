<!DOCTYPE html>
<html>
<head profile="http://www.w3.org/2005/10/profile">
	<title>CapMetro Bus Status</title>
	
	<!-- Icon from http://www.softicons.com/system-icons/web0.2ama-icons-by-chrfb/maps-bus-icon -->
	<link rel="icon" type="image/png" href="/favicon.png">
	<link rel="apple-touch-icon" href="/favicon-ios.png"/>

	<meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>

	<link href="styles.css" rel="stylesheet" type="text/css">
	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script>
		var underscore = _.noConflict();
	</script>

</head>
<body>
	<script>
	var vehicles;

	// Load the bus list from the web server
	var busStatusUrl = location.origin + "/VehicleLocations";
	$.ajax({
		url: busStatusUrl,
		
		// Tell jQuery we're expecting JSONP
		dataType: "jsonp",

		// Work with the response
		success: function( response ) {
			var package = response["soap:Envelope"]["soap:Body"].FleetlocationResponse;
			console.log( package ); // server response
			vehicles = package.Vehicles.Vehicle;
			finishLoad();
		},
		
		error: function( jqXHR, statusText, error ) {
			console.log( statusText );
		}
	});

	// Consumes the list of vehicles and fills the route picker
	function finishLoad() {
		// Find all the unique routes
		var routes = underscore.uniq( vehicles, false, function( item ) { return item.Route } );
		routes = underscore.sortBy( routes, function( v ) { return parseInt( v.Route ); } );
		$.each( routes, function( i, v ) {
			if( v.Route === "" ) {
				return;
			}
			$("<option/>").text( v.Route ).attr( "value", v.Route ).appendTo( "#routesList" );
		} );

		// Pre-select the 19 route
		$("#routesList").val( "19" );
		showRoute( "19" );

		$("#loading").css("display", "none")
		$("#content").css("display", "block")
	}

	// Converts a location string (e.g. "1.234,-5.678") to a Google Maps location object 
	function parseLocation( locationStr ) {
		var parts = locationStr.split( "," );
		var lat = parseFloat( parts[0] );
		var lon = parseFloat( parts[1] );
		return { lat: lat, lng: lon };
	}
	
	// Converts a value between 0 and 360 to textual form, e.g. "NW"
	function directionToText( hdg ) {
		var half = 45 / 2;
		if( hdg > (360 - half) || hdg <= (0 + half) ) {
			return "North";
		}
		else if( hdg > (0 + half) && hdg <= (90 - half) ) {
			return "Northeast";
		}
		else if( hdg > (90 - half) && hdg <= (90 + half) ) {
			return "East";
		}
		else if( hdg > (90 + half) && hdg <= (180 - half) ) {
			return "Southeast";
		}
		else if( hdg > (180 - half) && hdg <= (180 + half) ) {
			return "South";
		}
		else if( hdg > (180 + half) && hdg <= (270 - half) ) {
			return "Southwest";
		}
		else if( hdg > (270 - half) && hdg <= (270 + half) ) {
			return "West";
		}
		else {
			return "Northwest";
		}
	}

	// Switches the display to show a particular route	
	function showRoute( route ) {
		$("#buses").empty()
		$.each( vehicles, function( i, v ) {
			if( v.Route !== route ) {
				return;
			}
			
			var bearing = directionToText( parseInt( v.Heading ) * 10 );

			var header = v.Signage;
			var status = v.Speed + " MPH, Heading " + bearing + " (" + v.Heading.trim() + "0\u00B0)";
			var footer = "Updated: " + v.Updatetime
			var pos = parseLocation( v.Position );
			
			var mapUrl = "https://maps.googleapis.com/maps/api/staticmap?";
			mapUrl += "key=AIzaSyCj73tIFXQfTsVWD83JQnMUho1PZa_YOLA";
			mapUrl += "&center=" + pos.lat + "," + pos.lng;
			mapUrl += "&zoom=15";
			mapUrl += "&size=350x262";
			mapUrl += "&scale=2";
			mapUrl += "&markers=color:red%7C" + pos.lat + "," + pos.lng;

			var elem = $("<div/>").addClass( "vehicleInfo" );
			$("<p/>").addClass( "busHeader" ).text( header ).appendTo( elem );
			$("<p/>").addClass( "busStatus" ).text( status ).appendTo( elem );
			$("<p/>").addClass( "busFooter" ).text( footer ).appendTo( elem );
			$("<img/>")
				.addClass( "busMap" )
				.attr( "src", mapUrl )
				.attr( "width", "350" )
				.attr( "height", "262" )
				.appendTo( elem );
			elem.appendTo( "#buses" );
		} );
	}
	</script>

	<div id="main">
		<div id="test"></div>
		
		<div id="loading">Loading...</div>

		<div id="content">
			<div id="routes">
				<p id="routesListLabel">Select Route</p>
				<select name="Route" id="routesList" onchange="javascript:showRoute(this.value)">
					<!-- Filled dynamically -->
				</select>
			</div>
			<div id="buses">
				<!-- Filled dynamically -->
			</div>
		</div>
	</div>
</body>
</html>
